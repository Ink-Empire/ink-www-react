# API Fixtures for E2E Testing

## Overview

API fixtures are JSON snapshots of real API responses, generated by backend contract tests. They serve as mock data for Playwright E2E tests, ensuring the frontend correctly handles actual API response structures.

## Architecture

```
ink-api (Backend)                    inked-in-www (Frontend)
       |                                      |
       v                                      v
Contract Tests ──> S3 Bucket ──> pull-fixtures.js ──> Playwright Tests
       |              |                       |              |
 Export JSON    Store by branch         Download JSON   Mock API calls
```

### Flow

1. Backend contract tests run in CI when API files change
2. Tests verify response structure AND export JSON fixtures
3. Fixtures upload to S3 (`s3://inked-in-images/fixtures/{branch}/`)
4. Frontend pulls fixtures before running E2E tests
5. Playwright uses fixtures to mock API responses

## Available Fixtures

| Fixture | Path | Description |
|---------|------|-------------|
| Artist Detail | `artist/detail.json` | Single artist profile response |
| Artist Search | `artist/search.json` | Artist search results with pagination |
| Artist Settings | `artist/settings-owner.json` | Artist settings (owner view) |
| Artist Working Hours | `artist/working-hours.json` | Artist availability schedule |
| Artist Dashboard Stats | `artist/dashboard-stats.json` | Artist dashboard statistics |
| Client Dashboard | `client/dashboard.json` | Client dashboard data |
| Client Favorites | `client/favorites.json` | User's favorite artists |
| Client Wishlist | `client/wishlist.json` | User's artist wishlist |
| Suggested Artists | `client/suggested-artists.json` | Recommended artists |
| Tattoo Detail | `tattoo/detail.json` | Single tattoo details |
| Tattoo Search | `tattoo/search.json` | Tattoo search results |
| Tattoo Create | `tattoo/create-response.json` | Response after creating tattoo |
| Tattoo Update | `tattoo/update-response.json` | Response after updating tattoo |
| User Profile | `user/profile.json` | User profile data |
| User Update | `user/update-response.json` | Response after updating profile |

## Usage

### Pulling Fixtures

```bash
# Pull fixtures for current branch
npm run pull:fixtures

# Pull fixtures for specific branch
npm run pull:fixtures -- main

# Force pull in local development
CI=true npm run pull:fixtures
```

### Using in Playwright Tests

```typescript
import { test, expect } from '@playwright/test';
import { apiFixtures } from '../fixtures/api';

test.describe('Dashboard', () => {
  test.beforeEach(async ({ page }) => {
    // Mock multiple endpoints
    await page.route('**/api/client/dashboard', route => {
      route.fulfill({ json: apiFixtures.client.dashboard });
    });

    await page.route('**/api/client/favorites', route => {
      route.fulfill({ json: apiFixtures.client.favorites });
    });
  });

  test('displays user favorites', async ({ page }) => {
    await page.goto('/dashboard');

    // Test against mocked data
    const favoriteCount = apiFixtures.client.favorites.favorites.length;
    await expect(page.getByTestId('favorites-count')).toHaveText(String(favoriteCount));
  });
});
```

### Mocking with Dynamic Data

```typescript
test('handles empty state', async ({ page }) => {
  // Override fixture with empty data
  await page.route('**/api/client/favorites', route => {
    route.fulfill({
      json: { favorites: [] }
    });
  });

  await page.goto('/dashboard');
  await expect(page.getByText('No favorites yet')).toBeVisible();
});
```

### Mocking Error Responses

```typescript
test('handles API error gracefully', async ({ page }) => {
  await page.route('**/api/client/dashboard', route => {
    route.fulfill({
      status: 500,
      json: { error: 'Internal server error' }
    });
  });

  await page.goto('/dashboard');
  await expect(page.getByText('Something went wrong')).toBeVisible();
});
```

### Type-Safe Fixtures

```typescript
import { apiFixtures, type ClientDashboard } from '../fixtures/api';

// TypeScript knows the shape of the data
const dashboard: ClientDashboard = apiFixtures.client.dashboard;
```

## CI/CD Integration

### Vercel Deployment

Fixtures are automatically pulled during Vercel builds. Ensure these environment variables are set in Vercel:

- `AWS_ACCESS_KEY_ID`
- `AWS_SECRET_ACCESS_KEY`
- `AWS_REGION` (default: us-east-1)

### GitHub Actions

```yaml
jobs:
  test:
    steps:
      - uses: actions/checkout@v4

      - name: Configure AWS
        uses: aws-actions/configure-aws-credentials@v4
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-region: us-east-1

      - name: Install dependencies
        run: npm ci

      - name: Pull API fixtures
        run: npm run pull:fixtures

      - name: Run E2E tests
        run: npm run test:e2e
```

## Local Development

### First-Time Setup

```bash
# Ensure AWS CLI is configured
aws configure

# Pull fixtures
npm run pull:fixtures
```

### Without AWS Access

If you don't have AWS access locally, you can:

1. Copy fixtures from another developer
2. Use the committed placeholder fixtures
3. Create mock fixtures manually for specific tests

## Updating Fixtures

Fixtures are automatically updated when:

1. API response structure changes in `ink-api`
2. Contract tests are added/modified in `ink-api/tests/Feature/Contracts/`
3. Changes are pushed to `main` or `develop` branches

### Manual Update (Backend)

```bash
# In ink-api directory
EXPORT_FIXTURES=true php artisan test --filter=Contracts
```

### Triggering Update from GitHub

1. Go to ink-api repository on GitHub
2. Actions > Export API Fixtures > Run workflow
3. Select branch and click "Run workflow"

## Troubleshooting

### Fixtures Not Found

```
Error: Cannot find module './artist/detail.json'
```

Run `npm run pull:fixtures` to download fixtures from S3.

### Permission Denied (S3)

```
fatal error: Unable to locate credentials
```

Ensure AWS credentials are configured:
- Locally: Run `aws configure`
- CI: Check `AWS_ACCESS_KEY_ID` and `AWS_SECRET_ACCESS_KEY` secrets

### Stale Fixtures

If tests fail due to outdated fixture structure:

1. Check if API was recently updated
2. Wait for backend CI to export new fixtures
3. Run `npm run pull:fixtures` to get latest

### Branch Fixtures Don't Exist

The script automatically falls back:
1. Try branch-specific fixtures
2. Fall back to `develop` fixtures
3. Fall back to `latest` fixtures

## Best Practices

1. **Test Real Structures**: Fixtures represent real API responses - test against them to catch frontend bugs early.

2. **Don't Modify Fixtures**: Never edit downloaded fixtures. If the API structure is wrong, fix it in the backend.

3. **Mock Variations**: Use fixture data as a base, then modify for edge cases:
   ```typescript
   const emptyDashboard = { ...apiFixtures.client.dashboard, appointments: [] };
   ```

4. **Keep Tests Deterministic**: Fixtures provide consistent data, making tests reproducible.

5. **Document Custom Mocks**: If a test needs data not in fixtures, add a comment explaining why.

## Related Documentation

- [ink-api: API Contract Testing](../../../ink-api/docs/api-contract-testing.md)
- [Playwright Mocking Guide](https://playwright.dev/docs/mock)
